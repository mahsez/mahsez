name: Mahsez CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - run: npx nx affected --target=build --base=origin/main --parallel=3

      # ðŸš€ Deploy Web App
      - name: Deploy Web to Vercel
        run: |
          npx vercel link \
            --yes \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }} \
            --scope=abdullahalmasudpersonals-projects \
            --project=mahsez-web

          npx vercel pull \
            --yes \
            --environment=production \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

          npx vercel build \
            --prod \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

          npx vercel deploy \
            --prebuilt \
            --prod \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

      # ðŸš€ Deploy admin App
      - name: Deploy Admin to Vercel
        run: |
          npx vercel link \
            --yes \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }} \
            --scope=abdullahalmasudpersonals-projects \
            --project=mahsez-admin

          npx vercel pull \
            --yes \
            --environment=production \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

          npx vercel build \
            --prod \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

          npx vercel deploy \
            --prebuilt \
            --prod \
            --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}


      # - name: Deploy Web
      #   run: npx vercel --prod --yes --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

#       - name: Deploy Admin
#         run: npx vercel --prod --yes --cwd apps/admin --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

      # # Diploy Web
      # - name: Deploy to Web
      #   run:
      #     cd apps/webs/web
      #     npx vercel --prod --yes --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

      # # Deploy Admin
      # - name: Deploy Admin
      #   run: |
      #     cd apps/admin
      #     npx vercel --prod --yes --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

      # - run: npx vercel --prod --yes --token=${{ secrets.MAHSEZ_VERCEL_TOKEN }}

      # - run: npm nx affected --target=test
# name: Mahsez CI/CD
# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#       # Step 1: à¦•à§‹à¦¡ à¦šà§‡à¦•à¦†à¦‰à¦Ÿ à¦•à¦°à¦¾
#       # - name: Checkout Code
#       - uses: actions/checkout@v3

#       # Step 2: Node.js à¦¸à§‡à¦Ÿà¦†à¦ª à¦•à¦°à¦¾
#       # - name: Set up Node.js
#       - uses: actions/setup-node@v2
#         with:
#           node-version: 20
#           cache: 'npm' # Caching dependencies

# name: Mahsez CI/CD
# on:
#   push:
#     branches:
#       - main
#   pull_request:

# permissions:
#   actions: read
#   contents: read

# jobs:
#   main:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           filter: tree:0
#           fetch-depth: 0

#       # This enables task distribution via Nx Cloud
#       # Run this command as early as possible, before dependencies are installed
#       # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
#       # Connect your workspace by running "nx connect" and uncomment this line to enable task distribution
#       # - run: npx nx start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="e2e-ci"

#       # Cache node_modules
#       - uses: actions/setup-node@v4
#         with:
#           node-version: 20
#           cache: 'npm'

#       - run: npm ci
#       - run: npx playwright install --with-deps

#       # Prepend any command with "nx record --" to record its logs to Nx Cloud
#       # - run: npx nx record -- echo Hello World
#       # When you enable task distribution, run the e2e-ci task instead of e2e
#       - run: npx nx run-many -t lint test build typecheck e2e
#       # Nx Cloud recommends fixes for failures to help you get CI green faster. Learn more: https://nx.dev/ci/features/self-healing-ci
#       - run: npx nx fix-ci
#         if: always()
